<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>منصة تحويل الطلاب – متوسطة المنذر بن عمرو الأنصاري</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase 9 (Modular) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDsii4NVTrm8w3H-6Q-MvSlpNt-3bOOdRA",
      authDomain: "student-referral-system.firebaseapp.com",
      projectId: "student-referral-system",
      storageBucket: "student-referral-system.firebasestorage.app",
      messagingSenderId: "733058040690",
      appId: "1:733058040690:web:8433171a09e55dd04913eb",
      measurementId: "G-SXQMH17B2B"
    };

    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    signInAnonymously(window.auth).catch(console.error);
  </script>

  <!-- مكتبات الطباعة والتصدير -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    /* ========== تصميم احترافي ========== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Arial',sans-serif;background:linear-gradient(135deg,#1e7e34 0%,#28a745 50%,#20c997 100%);min-height:100vh;padding:20px;direction:rtl}
    .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#1e7e34 0%,#28a745 100%);color:#fff;padding:30px;text-align:center;position:relative}
    .header::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1.5" fill="white" opacity="0.1"/><circle cx="40" cy="80" r="1" fill="white" opacity="0.1"/></svg>');background-size:100px 100px}
    .header h1{font-size:2.2em;margin-bottom:10px;position:relative;z-index:1;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .header .school-info{font-size:1.1em;opacity:.95;position:relative;z-index:1}
    .form-container{padding:40px;background:#fff}
    .form-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:25px}
    label{font-weight:bold;color:#1e7e34;margin-bottom:8px;display:block;font-size:1.1em}
    input[type="text"],input[type="date"],textarea,select{width:100%;padding:15px;border:2px solid #e1e8ed;border-radius:10px;font-size:16px;background:#f8f9fa;transition:all .3s ease}
    input:focus,textarea:focus,select:focus{border-color:#28a745;box-shadow:0 0 0 3px rgba(40,167,69,.1);outline:none;background:#fff}
    textarea{resize:vertical;height:100px}
    .procedures-section{background:linear-gradient(135deg,#f8f9fa 0%,#e8f5e8 100%);border-left:5px solid #28a745;border-radius:15px;padding:30px;margin:30px 0}
    .procedures-section h3{color:#1e7e34;margin-bottom:20px;font-size:1.3em;display:flex;align-items:center;gap:10px;font-weight:bold}
    .procedure-item{background:#fff;border-radius:10px;padding:20px;margin-bottom:15px;border:1px solid #e1e8ed;transition:all .3s ease;position:relative;border-left:3px solid #20c997}
    .procedure-item:hover{box-shadow:0 5px 15px rgba(40,167,69,.1);transform:translateY(-2px)}
    .procedure-item.completed{border-color:#28a745;background:linear-gradient(135deg,#f8fff9 0%,#e8f5e8 100%);border-left:3px solid #28a745}
    .procedure-header{display:flex;align-items:center;margin-bottom:15px;gap:10px;font-weight:bold;color:#1e7e34}
    .completion-badge{position:absolute;top:10px;left:10px;background:#28a745;color:#fff;padding:5px 10px;border-radius:20px;font-size:12px;display:none}
    .procedure-item.completed .completion-badge{display:block}
    .signature-section{background:linear-gradient(135deg,#f1f3f4 0%,#e8f5e8 100%);border:2px dashed #28a745;border-radius:10px;padding:20px;margin-top:20px}
    .signature-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px}
    .action-buttons{display:flex;gap:15px;justify-content:center;margin-top:40px;flex-wrap:wrap}
    .btn{padding:15px 30px;border:none;border-radius:50px;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:10px;text-decoration:none;min-width:180px;justify-content:center;text-shadow:0 1px 2px rgba(0,0,0,.1);transition:all .3s ease}
    .btn-primary{background:linear-gradient(135deg,#1e7e34 0%,#28a745 100%);color:#fff;border:2px solid #1e7e34}
    .btn-success{background:linear-gradient(135deg,#20c997 0%,#17a2b8 100%);color:#fff;border:2px solid #20c997}
    .btn-info{background:linear-gradient(135deg,#17a2b8 0%,#007bff 100%);color:#fff;border:2px solid #17a2b8}
    .btn-warning{background:linear-gradient(135deg,#ffc107 0%,#fd7e14 100%);color:#1e7e34;border:2px solid #ffc107;font-weight:bold}
    .btn:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(30,126,52,.3)}
    .success-message,.error-message{padding:15px;border-radius:10px;margin:20px 0;display:none}
    .success-message{background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);color:#155724;border:1px solid #28a745;border-left:4px solid #1e7e34}
    .error-message{background:linear-gradient(135deg,#f8d7da 0%,#f5c6cb 100%);color:#721c24;border:1px solid #dc3545;border-left:4px solid #721c24}
    @media(max-width:768px){.form-row,.signature-row{grid-template-columns:1fr}.action-buttons{flex-direction:column}.btn{min-width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-school"></i> تحويل طالب لإدارة المدرسة</h1>
      <div class="school-info">
        <div>متوسطة المنذر بن عمرو الأنصاري</div>
        <div>مكتب تعليم العوالي – وزارة التعليم</div>
        <div>مدير المدرسة: خالد المطيري</div>
      </div>
    </div>

    <div class="form-container">
      <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i> <span id="successText"></span></div>
      <div class="error-message" id="errorMessage"><i class="fas fa-exclamation-circle"></i> <span id="errorText"></span></div>

      <div class="saved-forms" id="savedFormsSection" style="display:none">
        <h4><i class="fas fa-save"></i> النماذج المحفوظة محليًا</h4>
        <div id="savedFormsList"></div>
      </div>

      <form id="studentForm">
        <div class="form-row">
          <div class="form-group">
            <label><i class="fas fa-user"></i> اسم الطالب:</label>
            <input type="text" name="studentName" placeholder="أدخل اسم الطالب..." required>
          </div>
          <div class="form-group">
            <label><i class="fas fa-graduation-cap"></i> الصف:</label>
            <select name="studentGrade" required>
              <option value="">اختر الصف</option>
              <option>الأول متوسط</option>
              <option>الثاني متوسط</option>
              <option>الثالث متوسط</option>
            </select>
          </div>
          <div class="form-group">
            <label><i class="fas fa-users"></i> الشعبة:</label>
            <select name="studentSection" required>
              <option value="">اختر الشعبة</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label><i class="fas fa-exclamation-triangle"></i> سبب التحويل:</label>
          <textarea name="referralReason" placeholder="اكتب سبب تحويل الطالب بالتفصيل..." required></textarea>
        </div>

        <!-- يمكنك لصق باقي أقسام الإجراءات والتوقيعات السابقة هنا -->
        <!-- للاختصار: أدرجها بنفس الشكل السابق -->

        <div class="action-buttons no-print">
          <button type="button" class="btn btn-warning" onclick="saveLocal()"><i class="fas fa-save"></i> حفظ مؤقت محليًا</button>
          <button type="button" class="btn btn-success" onclick="saveCloud()"><i class="fas fa-cloud-upload-alt"></i> رفع إلى السحابة</button>
          <button type="button" class="btn btn-primary" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> حفظ PDF</button>
          <button type="button" class="btn btn-info" onclick="printForm()"><i class="fas fa-print"></i> طباعة</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ========== Firebase دوال ========== */
    async function saveCloud(){
      const frm=document.studentForm;
      if(!frm.checkValidity()){frm.reportValidity();return;}
      try{
        await addDoc(collection(window.db,'referrals'),{
          ...Object.fromEntries(new FormData(frm)),
          createdAt: serverTimestamp()
        });
        showMessage('✅ تم الرفع إلى Firestore بنجاح','success');
      }catch(e){showMessage('❌ فشل الرفع','error'); console.error(e);}
    }
    async function loadCloud(){
      const q=query(collection(window.db,'referrals'), orderBy('createdAt','desc'));
      const snap=await getDocs(q);
      snap.forEach(d=>console.log(d.id,d.data()));
    }

    /* ========== محلي & PDF & طباعة ========== */
    function saveLocal(){
      localStorage.setItem('referralDraft',JSON.stringify(Object.fromEntries(new FormData(document.studentForm))));
      showMessage('💾 تم الحفظ المحلي','success');
    }
    function loadLocal(){
      const d=JSON.parse(localStorage.getItem('referralDraft')||'{}');
      Object.keys(d).forEach(k=>{const el=document.querySelector(`[name="${k}"]`); if(el) el.value=d[k];});
    }
    async function generatePDF(){
      const loading=document.createElement('div'); loading.innerHTML='<div class="spinner"></div>جارٍ إنشاء PDF...'; loading.style.textAlign='center';
      document.body.appendChild(loading);
      try{
        const canvas=await html2canvas(document.querySelector('.container'),{scale:2,backgroundColor:'#fff'});
        const {jsPDF}=window.jspdf; const pdf=new jsPDF('p','mm','a4');
        const imgData=canvas.toDataURL('image/png');
        const imgWidth=210; const pageHeight=295; const imgHeight=(canvas.height*imgWidth)/canvas.width;
        let heightLeft=imgHeight, position=0;
        pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight); heightLeft-=pageHeight;
        while(heightLeft>=0){position=heightLeft-imgHeight; pdf.addPage(); pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight); heightLeft-=pageHeight;}
        const fileName=`تحويل_طالب_${document.querySelector('[name="studentName"]').value||'طالب'}_${new Date().toLocaleDateString('ar-SA').replace(/\//g,'-')}.pdf`;
        pdf.save(fileName); showMessage('✅ تم إنشاء PDF','success');
      }catch(e){showMessage('❌ فشل إنشاء PDF','error'); console.error(e);}
      document.body.removeChild(loading);
    }
    function printForm(){ window.print(); }
    function showMessage(txt,t){
      const el=document.getElementById(t==='success'?'successMessage':'errorMessage');
      const sp=document.getElementById(t==='success'?'successText':'errorText');
      sp.textContent=txt; el.style.display='block'; setTimeout(()=>el.style.display='none',5000);
    }

    /* ========== تهيئة أولية ========== */
    document.addEventListener('DOMContentLoaded',()=>{
      loadLocal();
      document.studentForm=document.getElementById('studentForm');
    });
  </script>
</body>
</html>
