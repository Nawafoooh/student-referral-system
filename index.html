<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة تحويل الطلاب - متوسطة المنذر بن عمرو الأنصاري</title>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAnalytics, logEvent } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        
        // جعل Firebase متاحاً عالمياً
        window.firebase = { initializeApp, getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, getAnalytics, logEvent };
    </script>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 50%, #20c997 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1.5" fill="white" opacity="0.1"/><circle cx="40" cy="80" r="1" fill="white" opacity="0.1"/></svg>');
            background-size: 100px 100px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header .school-info {
            font-size: 1.1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* إضافة مؤشر حالة الاتصال */
        .connection-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .connection-status.online {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }

        .connection-status.offline {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        .form-container {
            padding: 40px;
            background: white;
        }

        .saved-forms {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #20c997;
        }

        .saved-forms h4 {
            margin-bottom: 15px;
            color: #1e7e34;
            font-weight: bold;
        }

        .saved-form-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #28a745;
            border-left: 3px solid #1e7e34;
            position: relative;
        }

        .saved-form-item.synced {
            border-left-color: #20c997;
        }

        .saved-form-item.synced::after {
            content: '\f0c7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            left: 10px;
            color: #20c997;
            font-size: 12px;
        }

        .saved-form-info {
            flex: 1;
        }

        .saved-form-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            min-width: auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: bold;
            color: #1e7e34;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        input[type="text"], input[type="date"], textarea, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            outline: none;
            background: white;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .procedures-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border-left: 5px solid #28a745;
            border-top: 2px solid #20c997;
        }

        .procedures-section h3 {
            color: #1e7e34;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .procedure-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
            position: relative;
            border-left: 3px solid #20c997;
        }

        .procedure-item:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.1);
            transform: translateY(-2px);
        }

        .procedure-item.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
            border-left: 3px solid #28a745;
        }

        .procedure-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            font-weight: bold;
            color: #1e7e34;
        }

        .completion-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }

        .procedure-item.completed .completion-badge {
            display: block;
        }

        .date-input {
            max-width: 200px;
        }

        .signature-section {
            background: linear-gradient(135deg, #f1f3f4 0%, #e8f5e8 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px dashed #28a745;
        }

        .signature-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            min-width: 180px;
            justify-content: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
            color: white;
            border: 2px solid #1e7e34;
        }

        .btn-success {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            color: white;
            border: 2px solid #20c997;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
            color: white;
            border: 2px solid #17a2b8;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #1e7e34;
            border: 2px solid #ffc107;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(30, 126, 52, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #28a745;
            border-left: 4px solid #1e7e34;
            display: none;
        }

        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #dc3545;
            border-left: 4px solid #721c24;
            display: none;
        }

        .warning-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #ffc107;
            border-left: 4px solid #856404;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-validation {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
        }

        .error-text {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .progress-indicator {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .infraction-select,
        .action-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all .3s ease;
        }
        .infraction-select:focus,
        .action-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40,167,69,.1);
            outline: none;
            background: #fff;
        }

        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            .action-buttons, .no-print, .top-controls, .saved-forms, .connection-status {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .form-row, .signature-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                min-width: 100%;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .form-container, .header {
                padding: 20px;
            }

            .saved-form-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .saved-form-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i> غير متصل
            </div>
            <h1><i class="fas fa-school"></i> تحويل طالب لإدارة المدرسة</h1>
            <div class="school-info">
                <div>متوسطة المنذر بن عمرو الأنصاري</div>
                <div>مكتب تعليم العوالي - وزارة التعليم</div>
                <div>مدير المدرسة: خالد المطيري</div>
            </div>
        </div>

        <div class="form-container">
            <!-- رسائل النجاح والخطأ -->
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> <span id="successText">تم الحفظ بنجاح!</span>
            </div>
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText">حدث خطأ!</span>
            </div>
            <div class="warning-message" id="warningMessage">
                <i class="fas fa-exclamation-triangle"></i> <span id="warningText">تحذير!</span>
            </div>

            <!-- النماذج المحفوظة -->
            <div class="saved-forms" id="savedFormsSection" style="display: none;">
                <h4><i class="fas fa-save"></i> النماذج المحفوظة</h4>
                <div id="savedFormsList"></div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>جارٍ المعالجة...</p>
            </div>

            <form id="studentForm">
                <!-- معلومات الطالب الأساسية -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentName"><i class="fas fa-user"></i> اسم الطالب:</label>
                        <input type="text" id="studentName" name="studentName" placeholder="أدخل اسم الطالب..." required>
                        <div class="error-text" id="studentNameError">يرجى إدخال اسم الطالب</div>
                    </div>
                    <div class="form-group">
                        <label for="studentGrade"><i class="fas fa-graduation-cap"></i> الصف:</label>
                        <select id="studentGrade" name="studentGrade" required>
                            <option value="">اختر الصف</option>
                            <option value="الأول متوسط">الأول متوسط</option>
                            <option value="الثاني متوسط">الثاني متوسط</option>
                            <option value="الثالث متوسط">الثالث متوسط</option>
                        </select>
                        <div class="error-text" id="studentGradeError">يرجى اختيار الصف</div>
                    </div>
                    <div class="form-group">
                        <label for="studentSection"><i class="fas fa-users"></i> الشعبة:</label>
                        <select id="studentSection" name="studentSection" required>
                            <option value="">اختر الشعبة</option>
                            <option value="1">الشعبة 1</option>
                            <option value="2">الشعبة 2</option>
                            <option value="3">الشعبة 3</option>
                            <option value="4">الشعبة 4</option>
                            <option value="5">الشعبة 5</option>
                            <option value="6">الشعبة 6</option>
                        </select>
                        <div class="error-text" id="studentSectionError">يرجى اختيار الشعبة</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="referralReason"><i class="fas fa-exclamation-triangle"></i> سبب التحويل:</label>
                    <textarea id="referralReason" name="referralReason" placeholder="اكتب سبب تحويل الطالب بالتفصيل..." required></textarea>
                    <div class="error-text" id="referralReasonError">يرجى إدخال سبب التحويل</div>
                </div>

                <!-- مؤشر التقدم -->
                <div class="progress-indicator">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <!-- إجراءات المعلم -->
                <div class="procedures-section">
                    <h3><i class="fas fa-chalkboard-teacher"></i> إجراءات علاج المشكلة من قبل المعلم</h3>
                    
                    <div class="procedure-item" id="teacherAction1Item">
                        <div class="completion-badge">مكتمل</div>
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الأول:
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="behaviourInfraction1"><i class="fas fa-list"></i> المخالفة السلوكية:</label>
                            <select id="behaviourInfraction1" class="infraction-select" onchange="fillActionDropdown(1)">
                                <option value="">-- اختر المخالفة --</option>
                                <option value="عدم التقيد باللباس المدرسي أو هيئة مخالفة للنظام المدرسي">عدم التقيد باللباس المدرسي أو هيئة مخالفة للنظام المدرسي</option>
                                <option value="تكرر النوم داخل الفصل">تكرر النوم داخل الفصل</option>
                                <option value="الحديث الجانبي">الحديث الجانبي</option>
                                <option value="مقاطعة المعلم أثناء الدرس">مقاطعة المعلم أثناء الدرس</option>
                                <option value="الخروج أو الدخول دون استئذان">الخروج أو الدخول دون استئذان</option>
                                <option value="تكرار خروج الطلاب ظهراً من البوابة أو التجمهر حولها">تكرار خروج الطلاب ظهراً من البوابة أو التجمهر حولها</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="takenAction1"><i class="fas fa-hand-pointer"></i> الإجراء المتخذ:</label>
                            <select id="takenAction1" class="action-select">
                                <option value="">-- اختر الإجراء --</option>
                            </select>
                        </div>
                        <textarea name="teacherAction1" placeholder="تفاصيل إضافية للإجراء الأول المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="teacherDate1" class="date-input">
                        </div>
                    </div>

                    <div class="procedure-item" id="teacherAction2Item">
                        <div class="completion-badge">مكتمل</div>
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الثاني:
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="behaviourInfraction2"><i class="fas fa-list"></i> المخالفة السلوكية:</label>
                            <select id="behaviourInfraction2" class="infraction-select" onchange="fillActionDropdown(2)">
                                <option value="">-- اختر المخالفة --</option>
                                <option value="عدم التقيد باللباس المدرسي أو هيئة مخالفة للنظام المدرسي">عدم التقيد باللباس المدرسي أو هيئة مخالفة للنظام المدرسي</option>
                                <option value="تكرر النوم داخل الفصل">تكرر النوم داخل الفصل</option>
                                <option value="الحديث الجانبي">الحديث الجانبي</option>
                                <option value="مقاطعة المعلم أثناء الدرس">مقاطعة المعلم أثناء الدرس</option>
                                <option value="الخروج أو الدخول دون استئذان">الخروج أو الدخول دون استئذان</option>
                                <option value="تكرار خروج الطلاب ظهراً من البوابة أو التجمهر حولها">تكرار خروج الطلاب ظهراً من البوابة أو التجمهر حولها</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="takenAction2"><i class="fas fa-hand-pointer"></i> الإجراء المتخذ:</label>
                            <select id="takenAction2" class="action-select">
                                <option value="">-- اختر الإجراء --</option>
                            </select>
                        </div>
                        <textarea name="teacherAction2" placeholder="تفاصيل إضافية للإجراء الثاني المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="teacherDate2" class="date-input">
                        </div>
                    </div>

                    <div class="procedure-item" id="teacherAction3Item">
                        <div class="completion-badge">مكتمل</div>
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الثالث:
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="behaviourInfraction3"><i class="fas fa-list"></i> المخالفة السلوكية:</label>
                            <select id="behaviourInfraction3" class="infraction-select" onchange="fillActionDropdown(3)">
                                <option value="">-- اختر المخالفة --</option>
                                <option value="عدم التقيد باللباس المدرسي أو هيئة مخالفة للنظام المدرسي">عدم التقيد باللباس المدرسي أو هيئة مخالفة للنظام المدرسي</option>
                                <option value="تكرر النوم داخل الفصل">تكرر النوم داخل الفصل</option>
                                <option value="الحديث الجانبي">الحديث الجانبي</option>
                                <option value="مقاطعة المعلم أثناء الدرس">مقاطعة المعلم أثناء الدرس</option>
                                <option value="الخروج أو الدخول دون استئذان">الخروج أو الدخول دون استئذان</option>
                                <option value="تكرار خروج الطلاب ظهراً من البوابة أو التجمهر حولها">تكرار خروج الطلاب ظهراً من البوابة أو التجمهر حولها</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="takenAction3"><i class="fas fa-hand-pointer"></i> الإجراء المتخذ:</label>
                            <select id="takenAction3" class="action-select">
                                <option value="">-- اختر الإجراء --</option>
                            </select>
                        </div>
                        <textarea name="teacherAction3" placeholder="تفاصيل إضافية للإجراء الثالث المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="teacherDate3" class="date-input">
                        </div>
                    </div>

                    <div class="signature-section">
                        <div class="signature-row">
                            <div class="form-group">
                                <label>اسم المعلم:</label>
                                <input type="text" name="teacherName" required>
                            </div>
                            <div class="form-group">
                                <label>التوقيع:</label>
                                <input type="text" name="teacherSignature" placeholder="التوقيع الرقمي">
                            </div>
                            <div class="form-group">
                                <label>التاريخ:</label>
                                <input type="date" name="teacherFormDate" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- سبب التحويل النهائي بعد الإجراءات -->
                <div class="procedures-section" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-left: 5px solid #ffc107;">
                    <h3 style="color: #856404;"><i class="fas fa-file-alt"></i> سبب التحويل النهائي</h3>
                    <div class="form-group">
                        <label for="finalReferralReason"><i class="fas fa-exclamation-triangle"></i> سبب التحويل بعد اتخاذ الإجراءات:</label>
                        <textarea id="finalReferralReason" name="finalReferralReason" placeholder="بعد تطبيق الإجراءات الثلاثة المذكورة أعلاه، يُحوّل الطالب لعدم تحسن سلوكه..." required style="min-height: 120px;"></textarea>
                        <div class="error-text" id="finalReferralReasonError">يرجى إدخال سبب التحويل النهائي</div>
                    </div>
                </div>

                <!-- إجراءات وكيل شؤون الطلاب -->
                <div class="procedures-section">
                    <h3><i class="fas fa-user-tie"></i> إجراءات علاج المشكلة من قبل وكيل شؤون الطلاب</h3>
                    
                    <div class="procedure-item">
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الأول:
                        </div>
                        <textarea name="viceAction1" placeholder="اكتب الإجراء الأول المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="viceDate1" class="date-input">
                        </div>
                    </div>

                    <div class="procedure-item">
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الثاني:
                        </div>
                        <textarea name="viceAction2" placeholder="اكتب الإجراء الثاني المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="viceDate2" class="date-input">
                        </div>
                    </div>

                    <div class="procedure-item">
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الثالث:
                        </div>
                        <textarea name="viceAction3" placeholder="اكتب الإجراء الثالث المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="viceDate3" class="date-input">
                        </div>
                    </div>

                    <div class="signature-section">
                        <div class="signature-row">
                            <div class="form-group">
                                <label>اسم الوكيل:</label>
                                <input type="text" name="viceName">
                            </div>
                            <div class="form-group">
                                <label>التوقيع:</label>
                                <input type="text" name="viceSignature" placeholder="التوقيع الرقمي">
                            </div>
                            <div class="form-group">
                                <label>التاريخ:</label>
                                <input type="date" name="viceFormDate">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- إجراءات الموجه الطلابي -->
                <div class="procedures-section">
                    <h3><i class="fas fa-user-graduate"></i> إجراءات علاج المشكلة من قبل الموجه الطلابي</h3>
                    
                    <div class="procedure-item">
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الأول:
                        </div>
                        <textarea name="counselorAction1" placeholder="اكتب الإجراء الأول المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="counselorDate1" class="date-input">
                        </div>
                    </div>

                    <div class="procedure-item">
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الثاني:
                        </div>
                        <textarea name="counselorAction2" placeholder="اكتب الإجراء الثاني المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="counselorDate2" class="date-input">
                        </div>
                    </div>

                    <div class="procedure-item">
                        <div class="procedure-header">
                            <i class="fas fa-clipboard-list"></i> الإجراء الثالث:
                        </div>
                        <textarea name="counselorAction3" placeholder="اكتب الإجراء الثالث المتخذ..."></textarea>
                        <div style="margin-top: 10px;">
                            <label>تاريخ التنفيذ:</label>
                            <input type="date" name="counselorDate3" class="date-input">
                        </div>
                    </div>

                    <div class="signature-section">
                        <div class="signature-row">
                            <div class="form-group">
                                <label>اسم الموجه:</label>
                                <input type="text" name="counselorName">
                            </div>
                            <div class="form-group">
                                <label>التوقيع:</label>
                                <input type="text" name="counselorSignature" placeholder="التوقيع الرقمي">
                            </div>
                            <div class="form-group">
                                <label>التاريخ:</label>
                                <input type="date" name="counselorFormDate">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons no-print">
                    <button type="button" class="btn btn-warning" onclick="saveForm()">
                        <i class="fas fa-save"></i> حفظ مؤقت
                    </button>
                    <button type="button" class="btn btn-primary" onclick="generatePDF()">
                        <i class="fas fa-file-pdf"></i> حفظ كـ PDF
                    </button>
                    <button type="button" class="btn btn-success" onclick="sendWhatsApp()">
                        <i class="fab fa-whatsapp"></i> إرسال واتساب
                    </button>
                    <button type="button" class="btn btn-info" onclick="printForm()">
                        <i class="fas fa-print"></i> طباعة
                    </button>
                    <button type="button" class="btn btn-info" id="syncButton" onclick="syncWithFirebase()" style="display: none;">
                        <i class="fas fa-cloud-upload-alt"></i> مزامنة مع السحابة
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // المتغيرات العامة
        let currentFormId = null;
        let firebaseInitialized = false;
        let db = null;
        let analytics = null;

        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDsii4NVTrm8w3H-6Q-MvSlpNt-3bQQdRA",
            authDomain: "student-referral-system.firebaseapp.com",
            projectId: "student-referral-system",
            storageBucket: "student-referral-system.firebasestorage.app",
            messagingSenderId: "733358040690",
            appId: "1:733358040690:web:843317la09e55dd04913eb",
            measurementId: "G-SXQMH17B2B"
        };

        // تهيئة Firebase
        async function initializeFirebase() {
            try {
                if (window.firebase) {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    db = window.firebase.getFirestore(app);
                    analytics = window.firebase.getAnalytics(app);
                    firebaseInitialized = true;
                    updateConnectionStatus(true);
                    document.getElementById('syncButton').style.display = 'flex';
                    console.log('تم تهيئة Firebase بنجاح');
                    return true;
                }
            } catch (error) {
                console.error('خطأ في تهيئة Firebase:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus(isOnline) {
            const statusElement = document.getElementById('connectionStatus');
            if (isOnline) {
                statusElement.className = 'connection-status online';
                statusElement.innerHTML = '<i class="fas fa-wifi"></i> متصل بالسحابة';
            } else {
                statusElement.className = 'connection-status offline';
                statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i> غير متصل';
            }
        }

        // حفظ البيانات في Firebase
        async function saveToFirebase(formData) {
            if (!firebaseInitialized || !db) {
                return { success: false, message: 'Firebase غير متاح' };
            }

            try {
                const dataToSave = {
                    ...formData,
                    createdAt: window.firebase.serverTimestamp(),
                    updatedAt: window.firebase.serverTimestamp(),
                    schoolName: 'متوسطة المنذر بن عمرو الأنصاري',
                    schoolPrincipal: 'خالد المطيري',
                    educationOffice: 'مكتب تعليم العوالي'
                };

                const docRef = await window.firebase.addDoc(
                    window.firebase.collection(db, 'referrals'), 
                    dataToSave
                );

                // تسجيل الحدث في Analytics
                if (analytics) {
                    window.firebase.logEvent(analytics, 'form_saved_to_firebase', {
                        student_grade: formData.studentGrade,
                        student_section: formData.studentSection
                    });
                }

                return { 
                    success: true, 
                    id: docRef.id, 
                    message: 'تم حفظ البيانات في السحابة بنجاح' 
                };

            } catch (error) {
                console.error('خطأ في حفظ البيانات في Firebase:', error);
                return { 
                    success: false, 
                    message: 'فشل في حفظ البيانات في السحابة: ' + error.message 
                };
            }
        }

        // مزامنة مع Firebase
        async function syncWithFirebase() {
            const syncButton = document.getElementById('syncButton');
            const originalText = syncButton.innerHTML;
            
            syncButton.disabled = true;
            syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ المزامنة...';

            try {
                const savedForms = JSON.parse(localStorage.getItem('studentReferralForms') || '[]');
                const unsyncedForms = savedForms.filter(form => !form.firebaseId);

                if (unsyncedForms.length === 0) {
                    showMessage('جميع البيانات متزامنة بالفعل', 'success');
                    return;
                }

                let syncedCount = 0;
                let failedCount = 0;

                for (const form of unsyncedForms) {
                    const result = await saveToFirebase(form.data);
                    if (result.success) {
                        // تحديث البيانات المحلية بـ Firebase ID
                        form.firebaseId = result.id;
                        form.syncedWithCloud = true;
                        syncedCount++;
                    } else {
                        failedCount++;
                    }
                }

                // حفظ التحديثات في localStorage
                localStorage.setItem('studentReferralForms', JSON.stringify(savedForms));
                loadSavedForms();

                if (failedCount === 0) {
                    showMessage(`تم مزامنة ${syncedCount} نموذج بنجاح`, 'success');
                } else {
                    showMessage(`تم مزامنة ${syncedCount} نموذج، فشل في ${failedCount} نموذج`, 'warning');
                }

            } catch (error) {
                console.error('خطأ في المزامنة:', error);
                showMessage('حدث خطأ أثناء المزامنة', 'error');
            } finally {
                syncButton.disabled = false;
                syncButton.innerHTML = originalText;
            }
        }

        // باقي الكود الأصلي...
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const teacherFormDate = document.querySelector('input[name="teacherFormDate"]');
            if (teacherFormDate) {
                teacherFormDate.value = today;
            }

            // تهيئة Firebase
            setTimeout(initializeFirebase, 1000);

            loadSavedForms();
            setupEventListeners();
            updateProgress();
        });

        function setupEventListeners() {
            document.getElementById('studentForm').addEventListener('input', debounce(autoSave, 2000));
            document.getElementById('studentForm').addEventListener('input', updateProgress);

            document.querySelectorAll('input, textarea, select').forEach(field => {
                field.addEventListener('input', function() {
                    this.classList.remove('form-validation');
                    const errorElement = document.getElementById(`${this.name}Error`);
                    if (errorElement) errorElement.style.display = 'none';
                });
            });
        }

        function updateProgress() {
            const form = document.getElementById('studentForm');
            const allFields = form.querySelectorAll('input[required], textarea[required], select[required]');
            const filledFields = Array.from(allFields).filter(field => field.value.trim() !== '');
            
            const teacherActions = ['teacherAction1', 'teacherAction2', 'teacherAction3'];
            const completedActions = teacherActions.filter(action => {
                const field = form.querySelector(`[name="${action}"]`);
                return field && field.value.trim() !== '';
            });

            teacherActions.forEach((action, index) => {
                const field = form.querySelector(`[name="${action}"]`);
                const item = document.getElementById(`${action}Item`);
                if (field && field.value.trim() !== '') {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            });

            const progressPercentage = ((filledFields.length + completedActions.length) / (allFields.length + teacherActions.length)) * 100;
            document.getElementById('progressBar').style.width = progressPercentage + '%';
        }

        function autoSave() {
            if (validateBasicFields()) {
                saveForm(true);
            }
        }

        async function saveForm(isAutoSave = false) {
            const formData = getFormData();
            
            if (!isAutoSave && !validateBasicFields()) {
                showMessage('يرجى ملء المعلومات الأساسية للطالب قبل الحفظ', 'error');
                return;
            }

            const formId = currentFormId || generateFormId(formData.studentName, formData.studentGrade, formData.studentSection);
            currentFormId = formId;

            const savedForm = {
                id: formId,
                studentName: formData.studentName,
                studentGrade: formData.studentGrade,
                studentSection: formData.studentSection,
                data: formData,
                lastModified: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };

            let savedForms = JSON.parse(localStorage.getItem('studentReferralForms') || '[]');
            const existingIndex = savedForms.findIndex(form => form.id === formId);
            
            if (existingIndex > -1) {
                savedForm.createdAt = savedForms[existingIndex].createdAt;
                savedForm.firebaseId = savedForms[existingIndex].firebaseId;
                savedForm.syncedWithCloud = savedForms[existingIndex].syncedWithCloud;
                savedForms[existingIndex] = savedForm;
            } else {
                savedForms.push(savedForm);
            }

            localStorage.setItem('studentReferralForms', JSON.stringify(savedForms));
            
            if (!isAutoSave) {
                showMessage('تم حفظ النموذج محلياً بنجاح', 'success');
                loadSavedForms();

                // محاولة الحفظ في Firebase تلقائياً
                if (firebaseInitialized && validateForm()) {
                    const firebaseResult = await saveToFirebase(formData);
                    if (firebaseResult.success) {
                        savedForm.firebaseId = firebaseResult.id;
                        savedForm.syncedWithCloud = true;
                        savedForms[existingIndex > -1 ? existingIndex : savedForms.length - 1] = savedForm;
                        localStorage.setItem('studentReferralForms', JSON.stringify(savedForms));
                        showMessage('تم حفظ النموذج محلياً وفي السحابة', 'success');
                        loadSavedForms();
                    }
                }
            }
        }

        function loadSavedForms() {
            const savedForms = JSON.parse(localStorage.getItem('studentReferralForms') || '[]');
            const savedFormsSection = document.getElementById('savedFormsSection');
            const savedFormsList = document.getElementById('savedFormsList');

            if (savedForms.length > 0) {
                savedFormsSection.style.display = 'block';
                savedFormsList.innerHTML = savedForms.map(form => `
                    <div class="saved-form-item ${form.syncedWithCloud ? 'synced' : ''}">
                        <div class="saved-form-info">
                            <strong>${form.studentName}</strong> - ${form.studentGrade} - الشعبة ${form.studentSection}<br>
                            <small>آخر تعديل: ${new Date(form.lastModified).toLocaleDateString('ar-SA')} ${form.syncedWithCloud ? '- محفوظ في السحابة' : '- محلي فقط'}</small>
                        </div>
                        <div class="saved-form-actions">
                            <button type="button" class="btn btn-primary btn-small" onclick="loadForm('${form.id}')">
                                <i class="fas fa-edit"></i> تحرير
                            </button>
                            <button type="button" class="btn btn-warning btn-small" onclick="deleteForm('${form.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                savedFormsSection.style.display = 'none';
            }
        }

        function loadForm(formId) {
            const savedForms = JSON.parse(localStorage.getItem('studentReferralForms') || '[]');
            const form = savedForms.find(f => f.id === formId);
            
            if (form) {
                currentFormId = formId;
                populateForm(form.data);
                showMessage('تم تحميل النموذج بنجاح', 'success');
                updateProgress();
                document.getElementById('studentForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteForm(formId) {
            if (confirm('هل أنت متأكد من حذف هذا النموذج؟')) {
                let savedForms = JSON.parse(localStorage.getItem('studentReferralForms') || '[]');
                savedForms = savedForms.filter(form => form.id !== formId);
                localStorage.setItem('studentReferralForms', JSON.stringify(savedForms));
                
                if (currentFormId === formId) {
                    currentFormId = null;
                    document.getElementById('studentForm').reset();
                    updateProgress();
                }
                
                loadSavedForms();
                showMessage('تم حذف النموذج بنجاح', 'success');
            }
        }

        function getFormData() {
            const formData = new FormData(document.getElementById('studentForm'));
            return Object.fromEntries(formData);
        }

        function populateForm(data) {
            Object.keys(data).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`) || document.getElementById(key);
                if (field) {
                    field.value = data[key];
                }
            });
        }

        function generateFormId(name, grade, section) {
            return `${name}_${grade}_${section}`.replace(/\s+/g, '_') + '_' + Date.now();
        }

        function validateBasicFields() {
            const requiredFields = ['studentName', 'studentGrade', 'studentSection', 'referralReason'];
            return requiredFields.every(field => {
                const element = document.querySelector(`[name="${field}"]`);
                return element && element.value.trim() !== '';
            });
        }

        function validateForm() {
            let isValid = true;
            const requiredFields = ['studentName', 'studentGrade', 'studentSection', 'referralReason', 'finalReferralReason', 'teacherName'];
            
            requiredFields.forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`) || document.getElementById(fieldName);
                const errorElement = document.getElementById(`${fieldName}Error`);
                
                if (!field || !field.value.trim()) {
                    if (field) field.classList.add('form-validation');
                    if (errorElement) errorElement.style.display = 'block';
                    isValid = false;
                } else {
                    if (field) field.classList.remove('form-validation');
                    if (errorElement) errorElement.style.display = 'none';
                }
            });

            return isValid;
        }

        async function generatePDF() {
            if (!validateForm()) {
                showMessage('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                saveForm();

                const elementsToHide = document.querySelectorAll('.no-print');
                elementsToHide.forEach(el => el.style.display = 'none');

                const canvas = await html2canvas(document.querySelector('.container'), {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 800,
                    height: null
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const studentName = document.getElementById('studentName').value || 'طالب';
                const fileName = `تحويل_طالب_${studentName}_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.pdf`;
                
                pdf.save(fileName);
                showMessage('تم إنشاء ملف PDF بنجاح', 'success');

                // تسجيل الحدث في Analytics
                if (analytics) {
                    window.firebase.logEvent(analytics, 'pdf_generated', {
                        student_name: studentName
                    });
                }

            } catch (error) {
                console.error('خطأ في إنشاء PDF:', error);
                showMessage('حدث خطأ في إنشاء ملف PDF. يرجى المحاولة مرة أخرى.', 'error');
            } finally {
                const elementsToShow = document.querySelectorAll('.no-print');
                elementsToShow.forEach(el => el.style.display = '');
                loading.style.display = 'none';
            }
        }

        function sendWhatsApp() {
            if (!validateForm()) {
                showMessage('يرجى ملء جميع الحقول المطلوبة قبل الإرسال', 'error');
                return;
            }

            const studentName = document.getElementById('studentName').value;
            const studentGrade = document.getElementById('studentGrade').value;
            const studentSection = document.getElementById('studentSection').value;
            const referralReason = document.getElementById('referralReason').value;
            const finalReferralReason = document.getElementById('finalReferralReason').value;
            const teacherName = document.querySelector('input[name="teacherName"]').value;

            const message = `🏫 *تحويل طالب لإدارة المدرسة*
            
📚 *متوسطة المنذر بن عمرو الأنصاري*
👨‍💼 مدير المدرسة: خالد المطيري

👤 *اسم الطالب:* ${studentName}
📖 *الصف:* ${studentGrade} - الشعبة ${studentSection}
⚠️ *سبب التحويل الأولي:* ${referralReason}
📋 *سبب التحويل النهائي:* ${finalReferralReason}

👨‍🏫 *المعلم المحول:* ${teacherName}
📅 *تاريخ التحويل:* ${new Date().toLocaleDateString('ar-SA')}

*تم إرسال هذا التحويل من المنصة الإلكترونية*`;

            const encodedMessage = encodeURIComponent(message);
            const vicePhoneNumber = '966565082015';
            const whatsappURL = `https://wa.me/${vicePhoneNumber}?text=${encodedMessage}`;
            
            window.open(whatsappURL, '_blank');

            // تسجيل الحدث في Analytics
            if (analytics) {
                window.firebase.logEvent(analytics, 'whatsapp_shared', {
                    student_grade: studentGrade
                });
            }
        }

        function printForm() {
            if (!validateForm()) {
                showMessage('يرجى ملء جميع الحقول المطلوبة قبل الطباعة', 'error');
                return;
            }
            window.print();
        }

        function showMessage(text, type = 'success') {
            const messageTypes = {
                'success': 'successMessage',
                'error': 'errorMessage', 
                'warning': 'warningMessage'
            };
            
            const messageElement = document.getElementById(messageTypes[type]);
            const textElement = document.getElementById(type + 'Text');
            
            if (messageElement && textElement) {
                textElement.textContent = text;
                messageElement.style.display = 'block';
                
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const actionsMap = {
            "عدم التقيد باللباس المدرسي أو هيئة مخالفة للنظام المدرسي":
                ["تنبيه شفهي من قبل المعلم","التنبيه شفهي من قبل المعلم للمرة الثانية","أخذ تعهد خطي من الطالب بالانضباط","إشعار ولي الأمر كتابياً وهاتفياً بمخالفة الطالب السلوكية","1- تنبيه الطالب المخالف من قبل وكيل المدرسة","2- استدعاء ولي الأمر وإخطاره بمخالفة الطالب السلوكية","3- حسم درجة من السلوك مع التمكين من فرصة التعويض"],
            "تكرر النوم داخل الفصل":
                ["تنبيه شفهي من قبل المعلم","التنبيه شفهي من قبل المعلم للمرة الثانية","أخذ تعهد خطي من الطالب بالانضباط","إشعار ولي الأمر كتابياً وهاتفياً بمخالفة الطالب السلوكية","1- تنبيه الطالب المخالف من قبل وكيل المدرسة","2- استدعاء ولي الأمر وإخطاره بمخالفة الطالب السلوكية","3- حسم درجة من السلوك مع التمكين من فرصة التعويض"],
            "الحديث الجانبي":
                ["تنبيه شفهي من قبل المعلم","التنبيه شفهي من قبل المعلم للمرة الثانية","أخذ تعهد خطي من الطالب بالانضباط","إشعار ولي الأمر كتابياً وهاتفياً بمخالفة الطالب السلوكية","1- تنبيه الطالب المخالف من قبل وكيل المدرسة","2- استدعاء ولي الأمر وإخطاره بمخالفة الطالب السلوكية","3- حسم درجة من السلوك مع التمكين من فرصة التعويض"],
            "مقاطعة المعلم أثناء الدرس":
                ["تنبيه شفهي من قبل المعلم","التنبيه شفهي من قبل المعلم للمرة الثانية","أخذ تعهد خطي من الطالب بالانضباط","إشعار ولي الأمر كتابياً وهاتفياً بمخالفة الطالب السلوكية","1- تنبيه الطالب المخالف من قبل وكيل المدرسة","2- استدعاء ولي الأمر وإخطاره بمخالفة الطالب السلوكية","3- حسم درجة من السلوك مع التمكين من فرصة التعويض"],
            "الخروج أو الدخول دون استئذان":
                ["تنبيه شفهي من قبل المعلم","التنبيه شفهي من قبل المعلم للمرة الثانية","أخذ تعهد خطي من الطالب بالانضباط","إشعار ولي الأمر كتابياً وهاتفياً بمخالفة الطالب السلوكية","1- تنبيه الطالب المخالف من قبل وكيل المدرسة","2- استدعاء ولي الأمر وإخطاره بمخالفة الطالب السلوكية","3- حسم درجة من السلوك مع التمكين من فرصة التعويض"],
            "تكرار خروج الطلاب ظهراً من البوابة أو التجمهر حولها":
                ["تنبيه شفهي من قبل المعلم","التنبيه شفهي من قبل المعلم للمرة الثانية","أخذ تعهد خطي من الطالب بالانضباط","إشعار ولي الأمر كتابياً وهاتفياً بمخالفة الطالب السلوكية","1- تنبيه الطالب المخالف من قبل وكيل المدرسة","2- استدعاء ولي الأمر وإخطاره بمخالفة الطالب السلوكية","3- حسم درجة من السلوك مع التمكين من فرصة التعويض"],
            "أخرى":
                ["تنبيه شفهي من قبل المعلم","التنبيه شفهي من قبل المعلم للمرة الثانية","أخذ تعهد خطي من الطالب بالانضباط","إشعار ولي الأمر كتابياً وهاتفياً بمخالفة الطالب السلوكية","1- تنبيه الطالب المخالف من قبل وكيل المدرسة","2- استدعاء ولي الأمر وإخطاره بمخالفة الطالب السلوكية","3- حسم درجة من السلوك مع التمكين من فرصة التعويض"]
        };

        function fillActionDropdown(actionNumber) {
            const infractionSel = document.getElementById(`behaviourInfraction${actionNumber}`);
            const actionSel = document.getElementById(`takenAction${actionNumber}`);
            const selected = infractionSel.value;

            actionSel.innerHTML = '<option value="">-- اختر الإجراء --</option>';
            if (actionsMap[selected]) {
                actionsMap[selected].forEach(act => {
                    const opt = document.createElement('option');
                    opt.value = act;
                    opt.textContent = act;
                    actionSel.appendChild(opt);
                });
            }
        }

        // فحص الاتصال بالإنترنت
        function checkOnlineStatus() {
            updateConnectionStatus(navigator.onLine && firebaseInitialized);
        }

        // مراقبة حالة الاتصال
        window.addEventListener('online', checkOnlineStatus);
        window.addEventListener('offline', checkOnlineStatus);

        // إعادة محاولة الاتصال بـ Firebase عند العودة online
        window.addEventListener('online', function() {
            if (!firebaseInitialized) {
                setTimeout(initializeFirebase, 1000);
            }
        });
    </script>
</body>
</html>
